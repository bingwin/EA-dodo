<?php
namespace org;

/**
 * @desc XML操作类
 * @author wangwei
 * @date 2018-10-30 16:16:26
 */
ini_set("display_errors", "OFF");

class XmlHandle{ 
    public $parser;   #a reference to the XML parser
    public $document; #the entire XML structure built up so far
    public $parent;   #a pointer to the current parent - the parent will be an array
    public $stack;    #a stack of the most recent parent at each nesting level
    public $last_opened_tag; #keeps track of the last tag opened.
    
    public function __construct(){
        $this->parser = xml_parser_create();
        xml_parser_set_option($this->parser, XML_OPTION_CASE_FOLDING, false);
        xml_set_object($this->parser, $this);
        xml_set_element_handler($this->parser, 'open','close');
        xml_set_character_data_handler($this->parser, 'data');
    }
    
    public function destruct(){
        xml_parser_free($this->parser);
    }
    
    public function parse($data){
        $this->document = array();
        $this->stack    = array();
        $this->parent   = &$this->document;
        return @xml_parse($this->parser, $data, true) ? $this->document : null;
    }
    
    public function open(&$parser, $tag, $attributes){
        $this->data = ''; #stores temporary cdata
        $this->last_opened_tag = $tag;
        if(is_array($this->parent) and array_key_exists($tag,$this->parent)){ #if you've seen this tag before
            if(is_array($this->parent[$tag]) and array_key_exists(0,$this->parent[$tag])){ #if the keys are numeric
                #this is the third or later instance of $tag we've come across
                $key = $this->count_numeric_items($this->parent[$tag]);
            }else{
                #this is the second instance of $tag that we've seen. shift around
                if(array_key_exists("$tag attr",$this->parent)){
                    $arr = array('0 attr'=>&$this->parent["$tag attr"], &$this->parent[$tag]);
                    unset($this->parent["$tag attr"]);
                }else{
                    $arr = array(&$this->parent[$tag]);
                }
                $this->parent[$tag] = &$arr;
                $key = 1;
            }
            $this->parent = &$this->parent[$tag];
        }else{
            $key = $tag;
        }
        if($attributes) $this->parent["$key attr"] = $attributes;
        $this->parent  = &$this->parent[$key];
        $this->stack[] = &$this->parent;
    }
    
    public function data(&$parser, $data){
        if($this->last_opened_tag != null) #you don't need to store whitespace in between tags
            $this->data .= $data;
    }
    
    public function close(&$parser, $tag){
        if($this->last_opened_tag == $tag){
            $this->parent = $this->data;
            $this->last_opened_tag = null;
        }
        array_pop($this->stack);
        if($this->stack) $this->parent = &$this->stack[count($this->stack)-1];
    }
    
    private function count_numeric_items(&$array){
        return is_array($array) ? count(array_filter(array_keys($array), 'is_numeric')) : 0;
    }

    /**
     * @desc xml转数组 
     * @author wangwei
     * @date 2018-10-30 15:49:34
     * @param string $xml
     * @return null|array
     */
    public static function unserialize($xml){
        $xmlObj = new XmlHandle();
        $data = $xmlObj->parse($xml);
        $xmlObj->destruct();
        return $data;
    } 
    
    /**
     * @desc 数组转xml
     * @author wangwei
     * @date 2018-10-30 15:49:55
     * @param array $data
     * @param int $level
     * @param string $prior_key
     * @return string
     */
    public static function serialize(&$data, $level = 0, $prior_key = null){
        if($level == 0){ ob_start(); echo '<?xml version="1.0" ?>',"\n"; }
        
        while(list($key, $value) = each($data))
            if(!strpos($key, ' attr')) 
            if(is_array($value) and array_key_exists(0, $value)){
                self::serialize($value, $level, $key);
        }else{
            $tag = $prior_key ? $prior_key : $key;
            echo str_repeat("\t", $level),'<',$tag;
            if(array_key_exists("$key attr", $data)){ #if there's an attribute for this element
                while(list($attr_name, $attr_value) = each($data["$key attr"]))
                    echo ' ',$attr_name,'="',htmlspecialchars($attr_value),'"';
                    reset($data["$key attr"]);
            }
            
            if(is_null($value)) echo " />\n";
            elseif(!is_array($value)) echo '>',htmlspecialchars($value),"</$tag>\n";
            else echo ">\n",self::serialize($value, $level+1),str_repeat("\t", $level),"</$tag>\n";
        }
        reset($data);
        
        if($level == 0){$str = ob_get_contents();ob_end_clean();return $str;}
        
    }
    
}

?>